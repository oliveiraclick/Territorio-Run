<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#f59e0b" />

  <!-- PWA Settings -->
  <link rel="manifest" href="./manifest.json" />
  <link rel="apple-touch-icon" href="/pwa-192x192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Territory" />

  <title>Territory Run: Conquista</title>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'gold-400': '#fbbf24',
            'gold-500': '#f59e0b',
            'gold-600': '#d97706',
            'surface-dark': '#18181b',
            'surface-light': '#ffffff',
            'neon-green': '#39ff14', // Mantendo para compatibilidade tempor√°ria
            'neon-red': '#ff073a',
            'neon-blue': '#00f3ff',
            'neon-purple': '#9d00ff',
            'dark-bg': '#09090b', // Zinc 950
            'panel-bg': 'rgba(24, 24, 27, 0.95)' // Zinc 900 + opacity
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom scrollbar for cyberpunk feel */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #1a1a1a;
    }

    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #39ff14;
    }

    .leaflet-container {
      background: #1a1a1a;
    }

    /* Prevent text selection for app-like feel */
    body {
      -webkit-user-select: none;
      user-select: none;
      background-color: #0a0a0a;
    }

    /* Cyberpunk Leaflet Popup Overrides */
    .leaflet-popup-content-wrapper {
      background-color: rgba(10, 10, 10, 0.95) !important;
      border: 1px solid #39ff14;
      border-radius: 8px !important;
      color: #fff !important;
      box-shadow: 0 0 15px rgba(57, 255, 20, 0.2) !important;
      backdrop-filter: blur(5px);
    }

    .leaflet-popup-tip {
      background-color: rgba(10, 10, 10, 0.95) !important;
      border: 1px solid #39ff14;
    }

    .leaflet-popup-content {
      margin: 10px !important;
      font-family: monospace;
    }

    .leaflet-container a.leaflet-popup-close-button {
      color: #666 !important;
    }

    .leaflet-container a.leaflet-popup-close-button:hover {
      color: #ff073a !important;
    }
  </style>
  <script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.31.0",
    "react-leaflet": "https://aistudiocdn.com/react-leaflet@^5.0.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0",
    "leaflet/": "https://aistudiocdn.com/leaflet@^1.9.4/",
    "leaflet": "https://aistudiocdn.com/leaflet@^1.9.4",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "@supabase/supabase-js": "https://aistudiocdn.com/@supabase/supabase-js@^2.86.2"
  }
}
</script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="/index.css">
</head>

<body class="bg-dark-bg text-white overflow-hidden">
  <div id="root">
    <!-- Native Loading Screen (Visible before React loads) -->

  </div>

  <!-- GLOBAL ERROR TRAP: Catch initialization crashes -->
  <script>
    window.onerror = function (message, source, lineno, colno, error) {
      const root = document.getElementById('root');
      if (root) {
        // Remove spinner if error occurs
        const spinner = document.getElementById('loading-screen');
        if (spinner) spinner.remove();

        root.innerHTML = `
            <div style="height: 100vh; width: 100vw; background: #0a0a0a; color: #ff073a; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; font-family: monospace; text-align: center;">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 20px;"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><path d="M12 9v4"></path><path d="M12 17h.01"></path></svg>
              <h1 style="font-size: 24px; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px;">Falha de Inicializa√ß√£o</h1>
              <p style="color: #fff; margin-bottom: 20px; max-width: 400px; font-size: 12px;">O sistema encontrou um erro cr√≠tico e n√£o p√¥de carregar os m√≥dulos principais.</p>
              <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333; width: 100%; max-width: 500px; overflow-x: auto; text-align: left;">
                <code style="color: #ff073a; font-size: 10px;">${message}</code>
              </div>
              <p style="color: #666; font-size: 10px; margin-top: 20px;">Verifique o Console do Desenvolvedor (F12) para mais detalhes.</p>
              <button onclick="window.location.reload()" style="margin-top: 30px; background: #39ff14; color: #000; border: none; padding: 12px 24px; font-weight: bold; cursor: pointer; border-radius: 4px; text-transform: uppercase;">Reiniciar Sistema</button>
            </div>
          `;
      }
    };
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      let refreshing = false;

      // Detectar quando o SW foi atualizado e est√° esperando
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (refreshing) return;
        refreshing = true;
        window.location.reload();
      });

      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => {
            console.log('SW registered: ', registration);

            // Verificar atualiza√ß√µes a cada 60 segundos
            setInterval(() => {
              registration.update();
            }, 60000);

            // Detectar quando h√° um novo SW esperando
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // H√° uma nova vers√£o dispon√≠vel!
                  showUpdateNotification(registration);
                }
              });
            });

            // Verificar se j√° h√° um SW esperando
            if (registration.waiting) {
              showUpdateNotification(registration);
            }
          })
          .catch(registrationError => {
            console.log('SW registration failed: ', registrationError);
          });
      });

      function showUpdateNotification(registration) {
        // Criar notifica√ß√£o de atualiza√ß√£o
        const updateBanner = document.createElement('div');
        updateBanner.id = 'update-banner';
        updateBanner.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          background: linear-gradient(135deg, #f59e0b 0%, #eab308 100%);
          color: black;
          padding: 16px;
          text-align: center;
          z-index: 99999;
          font-family: system-ui, -apple-system, sans-serif;
          font-weight: bold;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          animation: slideDown 0.3s ease-out;
        `;
        
        updateBanner.innerHTML = `
          <div style="max-width: 600px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 12px;">
            <span style="flex: 1; font-size: 14px;">üéâ Nova vers√£o dispon√≠vel!</span>
            <button id="update-btn" style="
              background: black;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              font-size: 13px;
              text-transform: uppercase;
              letter-spacing: 0.5px;
            ">Atualizar Agora</button>
            <button id="dismiss-btn" style="
              background: transparent;
              color: black;
              border: 2px solid black;
              padding: 10px 16px;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              font-size: 13px;
            ">‚úï</button>
          </div>
        `;

        // Adicionar anima√ß√£o
        const style = document.createElement('style');
        style.textContent = `
          @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
          }
        `;
        document.head.appendChild(style);

        document.body.appendChild(updateBanner);

        // Bot√£o de atualizar
        document.getElementById('update-btn').addEventListener('click', () => {
          if (registration.waiting) {
            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
          }
        });

        // Bot√£o de dispensar
        document.getElementById('dismiss-btn').addEventListener('click', () => {
          updateBanner.remove();
        });
      }
    }
  </script>

  <!-- CRITICAL: Entry Point for React Application -->

  <script type="module" src="/index.tsx"></script>
</body>

</html>